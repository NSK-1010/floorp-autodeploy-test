name: Arch AUR Repository Push

on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest

    container:
      image: archlinux:latest
      
      options: --privileged
      
      env:
        GIT_NAME: ${{ secrets.GIT_NAME }}
        GIT_EMAIL: ${{ secrets.GIT_EMAIL }}

    steps:
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2.4.0
      with:
        key: ${{ secrets.SSH_KEY }}
        name: id_rsa
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
    - name: Make PKGBUILD and .SRCINFO
      run: |
        pacman -S --needed git curl jq base-devel
        git config --global user.name "${{ GIT_NAME }}"
        git config --global user.email "${{ GIT_EMAIL }}"
        git clone ssh://aur@aur.archlinux.org/floorp.git
        cd floorp
        bash push.bash
        makepkg --printsrcinfo > .SRCINFO
        git add -A
        git commit -m "$(curl https://api.github.com/repos/Floorp-Projects/Floorp/releases | jq '.[0].tag_name' | sed s/\"//g)"
        git push origin master
